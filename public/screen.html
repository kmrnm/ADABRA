<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADABRA</title>
    <link rel="stylesheet" href="/css/app.css" />
    <link rel="stylesheet" href="/css/screen.css" />
</head>

<body class="screen">
    <div class="container">
        <div class="topbar">
            <div class="brand"><span class="brand-dot"></span>ADABRA</div>
            <div class="muted">Spectator Screen</div>
        </div>

        <div class="card screenCard">
            <div class="screenHeader">
                <div class="roomBlock">
                    <div class="muted">Room</div>
                    <div id="roomCode" class="screenRoom">—</div>
                </div>

                <div class="phaseBlock">
                    <div class="muted">Round</div>
                    <div id="round" class="screenPhase">0</div>
                </div>


                <div class="timerBlock">
                    <div class="muted">Time</div>
                    <div id="time" class="screenTime">00:00.0</div>
                </div>
            </div>

            <div id="lockedBanner" class="lockedBanner" style="display:none;">
                —
            </div>

            <div id="timeUpBanner" class="lockedBanner err" style="display:none;">
                TIME IS UP!
            </div>

            <div class="screenBody">
                <div class="screenCol">
                    <div class="muted" style="font-weight:900; letter-spacing:.4px;">Scoreboard</div>
                    <div id="scoreboard" class="screenScoreboard"></div>
                </div>

                <div class="screenCol rightCol">
                    <div class="muted" style="font-weight:900; letter-spacing:.4px;">Last buzz</div>
                    <div id="lastBuzz" class="lastBuzzBig">—</div>

                    <div class="muted" style="margin-top:14px;">Tip</div>
                    <div class="tipText">Players open: <strong>/play</strong> and enter room code.</div>
                </div>
            </div>
        </div>
        <footer class="app-footer">
            Made with JS and <span class="heart">❤</span> by kamrandroid
        </footer>
    </div>
    <div id="confettiWrap" class="confettiWrap"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        socket.on("errorMsg", (text) => {
            console.warn("Screen errorMsg:", text);
        });


        const roomCodeEl = document.getElementById("roomCode");
        const roundEl = document.getElementById("round");
        const timeEl = document.getElementById("time");
        const lastBuzzEl = document.getElementById("lastBuzz");
        const lockedBannerEl = document.getElementById("lockedBanner");
        const scoreboardEl = document.getElementById("scoreboard");
        const timeUpBannerEl = document.getElementById("timeUpBanner");

        let currentRoom = null;

        function formatMs(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            const t = Math.floor((ms % 1000) / 100);
            return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}.${t}`;
        }

        function updateTimerWarning(el, ms, phase, isTimeUp) {
            const last3 = (phase === "armed" && ms <= 3000 && ms > 0);
            const danger = Boolean(isTimeUp) || last3;

            el.classList.toggle("timerDanger", danger);
            el.classList.toggle("timerPulse", danger);
        }


        function getQueryRoom() {
            const params = new URLSearchParams(location.search);
            const r = params.get("room");
            return r ? r.trim().toUpperCase() : "";
        }

        function teamNameFromState(state, teamId) {
            const t = (state.teams || []).find(x => String(x.id) === String(teamId));
            return t ? t.name : `Team ${teamId}`;
        }

        function renderScoreboard(teams) {
            scoreboardEl.innerHTML = "";
            // sort by score desc
            const sorted = [...(teams || [])].sort((a, b) => (b.score || 0) - (a.score || 0));
            for (const t of sorted) {
                const row = document.createElement("div");
                row.className = "screenTeamRow";
                row.innerHTML = `
          <div class="screenTeamName">${t.name}</div>
          <div class="screenTeamScore">${t.score}</div>
        `;
                scoreboardEl.appendChild(row);
            }
        }

        function joinRoom(roomCode) {
            currentRoom = roomCode;
            roomCodeEl.textContent = roomCode || "—";
            if (!roomCode) return;

            socket.emit("joinRoom", { roomCode });
        }


        joinRoom(getQueryRoom());

        socket.on("roomState", (state) => {
            if (!currentRoom || state.roomCode !== currentRoom) return;

            roundEl.textContent = String(state.roundNumber ?? 0);
            timeEl.textContent = formatMs(state.remainingMs || 0);

            const isTimeUp = Boolean(state.timeUpAt);
            updateTimerWarning(timeEl, state.remainingMs || 0, state.phase, isTimeUp);
            if (typeof timeUpBannerEl !== "undefined" && timeUpBannerEl) {
                timeUpBannerEl.style.display = isTimeUp ? "block" : "none";
            }

            renderScoreboard(state.teams);

            if (!state.lastBuzz) {
                lastBuzzEl.textContent = "—";
            } else {
                const name = teamNameFromState(state, state.lastBuzz.teamId);
                const isFirst =
                    state.firstBuzzTeamId &&
                    String(state.firstBuzzTeamId) === String(state.lastBuzz.teamId);

                lastBuzzEl.textContent = isFirst ? `${name} buzzed first` : `${name} buzzed`;
            }

            if (state.phase === "locked" && state.lastBuzz) {
                lockedBannerEl.style.display = "block";
                lockedBannerEl.textContent = `${teamNameFromState(state, state.lastBuzz.teamId)} answering`;
            } else {
                lockedBannerEl.style.display = "none";
            }
        });


        const TEAM_COLORS = ["#7c5cff", "#31d3ff", "#19d17f", "#ffd400", "#ff5a00", "#ff3d88"];
        function teamColor(teamId) {
            const n = Number(teamId);
            const i = Number.isFinite(n) ? ((n - 1) % TEAM_COLORS.length) : 0;
            return TEAM_COLORS[i];
        }

        const confettiWrap = document.getElementById("confettiWrap");

        function burstConfetti(color) {
            if (!confettiWrap) return;
            const w = window.innerWidth;
            const x0 = w * 0.5;
            for (let i = 0; i < 18; i++) {
                const el = document.createElement("div");
                el.className = "confetti";
                el.style.background = color;
                el.style.left = (x0 + (Math.random() * 240 - 120)) + "px";
                el.style.top = (80 + Math.random() * 40) + "px";
                el.style.transform = `rotate(${Math.random() * 180}deg)`;
                confettiWrap.appendChild(el);
                setTimeout(() => el.remove(), 950);
            }
        }

        socket.on("correctFx", ({ teamId }) => {
            burstConfetti(teamColor(teamId));
        });

    </script>
</body>

</html>